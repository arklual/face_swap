## Контекст

На страницах персонализации есть 2 стадии превью:
- `prepay` — первые страницы до оплаты.
- `postpay` — полный набор после оплаты.

Проблема: по ссылке вида `.../personalize?step=preview&stage=postpay&jobId=...` UI показывал экран как «предпросмотр», а при незавершённой postpay-генерации мог ломаться/показывать некорректный контент.

Ожидаемое поведение:
- Это **просмотр** (после оплаты).
- Пока `postpay` ещё генерируется, нужно показывать **страницы из prepay-предпросмотра**.
- В галерее должен быть индикатор, что **генерируются следующие страницы**.

## Реализация

Frontend изменения:
- `wonderwraps/src/app/routes/personalization/BookPersonalization.tsx`
  - при `stage=postpay` и статусе != `completed` запрашивает `GET /preview/{jobId}?stage=prepay`.
  - продолжает polling `GET /status/{jobId}` до `completed`, даже если preview уже доступен.
  - когда статус становится `completed`, переключается на `GET /preview/{jobId}?stage=postpay`.
- `wonderwraps/src/app/routes/personalization/components/PreviewGallery.tsx`
  - добавлен режим `mode='view'` (копирайтинг “Просмотр книги”).
  - добавлен notice + плейсхолдеры в списке миниатюр: “Генерируем следующие страницы...”.
  - скрыта кнопка “Добавить в корзину” в режиме просмотра.

## Проверка

Нужно проверить на стенде:
- `stage=postpay` при статусе `postpay_generating`:
  - видны prepay страницы (картинки из предпросмотра).
  - есть индикатор, что генерируются следующие страницы.
- после `completed`:
  - галерея переключается на полный набор postpay страниц.

## Риски/заметки

- В `GET /preview?stage=prepay` ответе `totalCount` сейчас равен количеству prepay страниц, поэтому в режиме просмотра во время генерации нет точного total.

## Доработка галереи (стабильность + кэш)

Проблемы в UI:
- иногда главная картинка не обновлялась при навигации;
- картинки могли перезагружаться заново из-за presigned URL (query params меняются) и/или лишних refetch.

Сделано:
- Стабилизирован индекс выбранной страницы:
  - при изменении `pages.length` выбранный индекс clamp'ится в допустимый диапазон;
  - `Next` больше не может увести индекс в отрицательное значение при пустом списке.
- Миниатюры и aria/labels теперь используют реальный `page.index` (номер страницы), а не позицию в массиве.
- Добавлен фронтовый blob-кэш для main image:
  - ключ кэша = URL без query (origin+pathname), поэтому новые presigned ссылки не ломают кэш;
  - показывается лёгкий overlay-лоадер при первом получении blob;
  - префетчатся соседние (prev/next) страницы.
- У preview query увеличен `staleTime` и отключён `refetchOnMount`, чтобы без нужды не получать новые presigned URL.

## Fix: мигание (белый экран → старая → новая)

Симптом:
- при перелистывании главная картинка показывала белый экран, затем старую, затем новую.

Причина:
- главная картинка принудительно remount'илась через `key`, что давало белый “провал” при каждом перелистывании;
- кэш-хук на промахе сначала ставил `src` в presigned URL, а затем заменял на blob URL (двойная смена src).

Исправление:
- убран `key` у main image (не ремоунтим компонент при смене страницы);
- `useCachedImageSrc` больше не “обнуляет”/не переключает src на presigned URL — он держит предыдущую картинку до готовности blob и затем атомарно подменяет.

## Финальная версия: скачивание страниц/книги + PDF

Требование:
- возможность открыть страницу “во всю высоту”
- скачать каждую страницу отдельно
- скачать все страницы разом
- скачать всю книгу PDF
- важно: доступно только в финальной версии (job.status == `completed`)

Backend:
- добавлены защищённые endpoints (только владелец job, только `completed`):
  - `GET /preview/{jobId}/download/page/{pageNum}` → PNG (Content-Disposition attachment)
  - `GET /preview/{jobId}/download/zip` → ZIP со страницами
  - `GET /preview/{jobId}/download/pdf` → PDF (multi-page через Pillow)

Frontend:
- добавлен `customFetchBlob` для скачивания бинарных файлов с `Authorization: Bearer ...`.
- в `PreviewGallery` добавлены кнопки:
  - “Во всю высоту” (UI toggle)
  - “Скачать страницу”
  - “Скачать все (ZIP)”
  - “Скачать PDF”
- кнопки скачивания показываются только когда `stage=postpay` и статус `completed`.

## Fix: падение страницы из-за missing export

Причина:
- В `PreviewGallery` был импорт новых download-функций из `@shared/api/wonderwraps`, но на стенде Vite ругался "does not provide an export" и весь роут падал.

Исправление:
- Убрали импорт download-функций из `@shared/api/wonderwraps` в `PreviewGallery`.
- Для скачивания используем прямой `fetch` к `${API_BASE_URL}/preview/{jobId}/download/...` с `Authorization: Bearer <token>`.
